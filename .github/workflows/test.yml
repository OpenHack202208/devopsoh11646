name: "PR - api-poi (.NET Core) v2 - Gitleaks"

on:
  pull_request:
    branches:
      - main
    paths:
      - "apis/poi/**"
  workflow_dispatch:

# Set envs
env:
  DOTNET_VERSION: "3.1.x"

jobs:
  buildtest:
    name: "Build and Test"
    runs-on: ubuntu-latest
    outputs:
      test_results: ${{ steps.unittestoutput.outputs.test_results }}
      test_outcome: ${{ steps.unittestoutput.outputs.test_outcome }}
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: '0'

      - name: detect-secrets
        uses: Hacks4Snacks/secret-search@main
        id: detectsecrets

      - name: "Stop workflow if secrets detected"
        if: steps.detectsecrets.outputs.exitcode == 1
        run: exit 1

      - name: "Setup .NET Core ${{ env.DOTNET_VERSION }}"
        uses: actions/setup-dotnet@v1
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: "Restore dependencies"
        working-directory: apis/poi
        run: dotnet restore

      - name: "Build the App"
        working-directory: apis/poi
        run: dotnet build --no-restore

      - name: "Run Unit Tests"
        id: unittest
        working-directory: apis/poi
        run: |
          dotnet test --no-build --filter "FullyQualifiedName~UnitTest" |& tee test_results.txt

          # break if 'dotnet test' failed
          test ${PIPESTATUS[0]} -eq 0
        continue-on-error: true

      - name: "Transform Unit Tests output"
        id: unittestoutput
        if: steps.unittest.outcome == 'failure'
        run: |
          test_results=$(cat test_results.txt)
          test_results="${test_results//'%'/'%25'}"
          test_results="${test_results//$'\n'/'%0A'}"
          test_results="${test_results//$'\r'/'%0D'}"
          echo "::set-output name=test_results::${test_results}"
          echo "::set-output name=test_outcome::${{ steps.unittest.outcome }}"
